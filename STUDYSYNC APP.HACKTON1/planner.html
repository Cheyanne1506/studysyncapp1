<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>StudySync AI - Planner</title>
<link rel="stylesheet" href="themes.css" />

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Arial,sans-serif}

.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:240px;background:var(--sidebar-bg);padding:20px}
.sidebar ul{list-style:none}
.nav-link{
  display:block;
  padding:12px;
  border-radius:8px;
  margin-bottom:12px;
  background:var(--sidebar-item);
  color:var(--text);
  text-decoration:none
}
.nav-link.active{background:var(--sidebar-hover)}

/* MAIN */
.main{flex:1;padding:24px}
.card{
  background:var(--card-bg);
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  margin-bottom:20px
}

.planner-layout{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px
}

/* WEEK GRID */
.week-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
  margin-top:12px
}
.day-col{display:flex;flex-direction:column;gap:6px}
.week-day{text-align:center;font-weight:bold}
.week-cell{
  background:var(--sidebar-item);
  border-radius:10px;
  padding:8px;
  min-height:70px;
  font-size:12px
}

/* FULL CALENDAR */
.calendar-header{display:flex;justify-content:space-between;margin-bottom:10px}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.calendar-day{background:var(--sidebar-item);padding:8px;border-radius:8px}
.day-name{text-align:center;font-size:12px;opacity:.7}

button{
  background:var(--sidebar-hover);
  border:none;
  border-radius:8px;
  padding:6px 12px;
  color:white;
  cursor:pointer
}

button:hover{opacity:.85}

input{
  background:var(--sidebar-item);
  border:none;
  border-radius:8px;
  padding:8px;
  color:var(--text)
}

.event{
  margin-top:4px;
  padding:4px;
  border-radius:6px;
  font-size:11px;
  color:white
}

@media(max-width:768px){
  .app{flex-direction:column}
  .sidebar{width:100%}
  .planner-layout{grid-template-columns:1fr}
}
</style>
</head>

<body class="theme-redblack">

<div class="app">

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>StudySync</h2>
  <ul>
    <li><a class="nav-link" href="home.html">Dashboard</a></li>
    <li><a class="nav-link" href="module.html">Modules</a></li>
    <li><a class="nav-link active" href="planner.html">Planner</a></li>
    <li><a class="nav-link" href="study.html">Study Mode</a></li>
    <li><a class="nav-link" href="progress.html">Progress</a></li>
    <li><a class="nav-link" href="settings.html">Settings</a></li>
  </ul>
</div>

<!-- MAIN -->
<div class="main">

<div class="planner-layout">

<!-- LEFT COLUMN -->
<div class="card">
  <h3 style="display:flex;justify-content:space-between;align-items:center">
    üìÖ This Week
    <button onclick="toggleFullCalendar()">üìÜ</button>
  </h3>

  <div class="week-grid" id="weekGrid"></div>

  <button style="margin-top:12px;width:100%" onclick="autoGenerateStudySessions()">
    ‚ö° Auto-Generate Study Plan
  </button>
</div>

<!-- RIGHT COLUMN -->
<div>

  <!-- TODO LIST -->
  <div class="card">
    <h3 id="todoHeading">üìù Today‚Äôs Tasks</h3>

    <div style="display:flex;gap:8px;margin-bottom:12px">
      <input id="todoInput" placeholder="New task" style="flex:1">
      <button onclick="addTodo()">Add</button>
    </div>

    <ul id="todoList" style="list-style:none;padding:0"></ul>
  </div>

  <!-- GOALS -->
  <div class="card">
    <h3>üéØ Focus Goals</h3>
    <ul>
      <li>‚úî 2 hours study per day</li>
      <li>‚úî Finish assignments</li>
      <li>‚úî Revise weekly</li>
    </ul>
  </div>

</div>
</div>

<!-- FULL CALENDAR -->
<div class="card">
  <div id="fullCalendar" style="display:none">
    <div class="calendar-header">
      <button onclick="prevMonth()">‚óÄ</button>
      <strong id="monthLabel"></strong>
      <button onclick="nextMonth()">‚ñ∂</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
</div>

</div>
</div>

<!-- üîΩ YOUR EXISTING SCRIPT GOES HERE üîΩ -->
<!-- (UNCHANGED ‚Äì keep exactly as you have it) -->
<script>
/* =========================
   GLOBAL DATE
========================= */
let currentDate = new Date();

/* =========================
   MODULE ‚Üí COLOR MAP
========================= */
function getModuleColorMap() {
  const modules = JSON.parse(localStorage.getItem('modules') || '[]');
  const palette = [
    '#ff3b30','#ff9500','#ffcc00',
    '#34c759','#30b0ff','#5856d6',
    '#ff2d55','#8e8e93'
  ];
  const map = {};
  modules.forEach((m,i)=> map[m.code] = palette[i % palette.length]);
  return map;
}

/* =========================
   FULL CALENDAR TOGGLE
========================= */
function toggleFullCalendar(){
  const cal = document.getElementById('fullCalendar');
  cal.style.display = cal.style.display === 'none' ? 'block' : 'none';
  renderCalendar();
}

/* =========================
   FULL CALENDAR (SYNCED)
========================= */
function renderCalendar(){
  const grid = document.getElementById('calendarGrid');
  const label = document.getElementById('monthLabel');
  grid.innerHTML = '';

  const y = currentDate.getFullYear();
  const m = currentDate.getMonth();

  label.textContent = currentDate.toLocaleString('default',{month:'long',year:'numeric'});

  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
    const el = document.createElement('div');
    el.className = 'day-name';
    el.textContent = d;
    grid.appendChild(el);
  });

  const first = new Date(y,m,1).getDay();
  const days = new Date(y,m+1,0).getDate();
  for(let i=0;i<first;i++) grid.appendChild(document.createElement('div'));

  const events = getPlannerCalendarEvents();
  const moduleColors = getModuleColorMap();

  for(let d=1; d<=days; d++){
    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    cell.innerHTML = `<strong>${d}</strong>`;

    const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    events.filter(e=>e.date===iso).forEach(e=>{
      const ev = document.createElement('div');
      ev.textContent = e.type ? `${e.module} ‚Äì ${e.type}` : e.title;
      ev.style.fontSize = '11px';
      ev.style.marginTop = '4px';
      ev.style.padding = '4px';
      ev.style.borderRadius = '6px';
      ev.style.color = '#fff';
      ev.style.background = moduleColors[e.moduleCode] || e.color || '#555';
      cell.appendChild(ev);
    });

    grid.appendChild(cell);
  }
}

function prevMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }

/* =========================
   WEEKLY PLANNER
========================= */
function getStartOfWeek(date=new Date()){
  const d=new Date(date);
  const day=d.getDay();
  const diff=d.getDate()-day+(day===0?-6:1);
  d.setDate(diff); d.setHours(0,0,0,0);
  return d;
}

function renderWeeklyPlanner() {
  const grid = document.getElementById('weekGrid');
  if (!grid) return;

  grid.innerHTML = '';

  const assessments = JSON.parse(localStorage.getItem('assessments') || '[]');
  const events = JSON.parse(localStorage.getItem('events') || '[]');
  const moduleColors = getModuleColorMap();
  const start = getStartOfWeek();

  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach((dayName, i) => {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    const iso = date.toISOString().slice(0, 10);

    const dueAssessments = assessments.filter(a => a.date === iso);
    const dayEvents = events.filter(e => e.date === iso);

    const col = document.createElement('div');
    col.className = 'day-col';
    col.innerHTML = `
      <div class="week-day">${dayName}</div>
      <div class="week-cell"></div>
    `;

    const cell = col.querySelector('.week-cell');

    if (dueAssessments.length === 0 && dayEvents.length === 0) {
      cell.innerHTML = `<small style="opacity:.6;">No due items</small>`;
    }

    // üìå Assessments
    dueAssessments.forEach(a => {
      const block = document.createElement('div');
      block.style.background = moduleColors[a.moduleCode] || '#666';
      block.style.borderRadius = '10px';
      block.style.padding = '8px';
      block.style.marginBottom = '6px';
      block.style.color = '#fff';
      block.style.fontSize = '12px';

      block.innerHTML = `
        <strong>${a.moduleCode}</strong><br>
        ${a.type}<br>
        <small>Due today</small>
      `;

      cell.appendChild(block);
    });

    // üìÖ Manual events
    dayEvents.forEach(e => {
      const ev = document.createElement('div');
      ev.style.background = e.color || '#444';
      ev.style.borderRadius = '10px';
      ev.style.padding = '8px';
      ev.style.marginBottom = '6px';
      ev.style.color = '#fff';
      ev.style.fontSize = '12px';

      ev.textContent = e.title;
      cell.appendChild(ev);
    });

    grid.appendChild(col);
  });
}


/* =========================
   HOME ‚Üí PLANNER SYNC
========================= */
function getPlannerCalendarEvents(){
  const manual=JSON.parse(localStorage.getItem('events')||'[]');
  const assessments=JSON.parse(localStorage.getItem('assessments')||'[]');

  const assessEvents=assessments.filter(a=>a.date).map(a=>({
    date:a.date,
    module:a.moduleCode,
    moduleCode:a.moduleCode,
    type:a.type,
    allDay:true
  }));

  return [...manual,...assessEvents];
}

/* =========================
   DAILY TODO LIST
========================= */
const TODO_KEY='dailyTodos';
const CLEAN_KEY='todoCleanupDate';

function todayISO(){ return new Date().toISOString().slice(0,10); }

function cleanupTodos(){
  const last=localStorage.getItem(CLEAN_KEY);
  const today=todayISO();
  if(last===today) return;

  let todos=JSON.parse(localStorage.getItem(TODO_KEY)||'[]');
  todos=todos.filter(t=>!t.done);
  localStorage.setItem(TODO_KEY,JSON.stringify(todos));
  localStorage.setItem(CLEAN_KEY,today);
}

function loadTodos(){
  cleanupTodos();
  return JSON.parse(localStorage.getItem(TODO_KEY)||'[]');
}

function saveTodos(t){ localStorage.setItem(TODO_KEY,JSON.stringify(t)); }

function renderTodos(){
  const list=document.getElementById('todoList');
  const heading=document.getElementById('todoHeading');
  heading.textContent=`üìù Tasks for ${new Date().toDateString()}`;
  list.innerHTML='';

  const todos=loadTodos();
  if(todos.length===0){
    list.innerHTML='<small style="opacity:.6">No tasks today</small>';
    return;
  }

  todos.forEach(t=>{
    const li=document.createElement('li');
    li.style.display='flex';
    li.style.gap='10px';

    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.checked=t.done;
    cb.onchange=()=>{ t.done=cb.checked; saveTodos(todos); renderTodos(); };

    const txt=document.createElement('div');
    txt.innerHTML=`${t.text}<br><small>Added: ${t.dateAdded}</small>`;
    if(t.done){ txt.style.textDecoration='line-through'; txt.style.opacity='.6'; }

    li.append(cb,txt);
    list.appendChild(li);
  });
}

function addTodo(){
  const input=document.getElementById('todoInput');
  if(!input.value.trim()) return;
  const todos=loadTodos();
  todos.push({text:input.value,done:false,dateAdded:todayISO()});
  saveTodos(todos);
  input.value='';
  renderTodos();
}

/* =========================
   INIT
========================= */
document.addEventListener('DOMContentLoaded',()=>{
  renderWeeklyPlanner();
  renderTodos();
  document.body.className=localStorage.getItem('theme')||'theme-redblack';
  document.body.style.fontFamily=localStorage.getItem('font')||'Arial';
});
function syncStudySessionsToCalendar() {
  const sessions = JSON.parse(localStorage.getItem('studySessions') || '[]');
  const moduleColors = getModuleColorMap();
  let events = JSON.parse(localStorage.getItem('events') || '[]');

  sessions.forEach(s => {
    const exists = events.some(e =>
      e.date === s.date &&
      e.source === 'study' &&
      e.topic === s.topic &&
      e.moduleCode === s.moduleCode
    );

    if (!exists) {
      events.push({
        date: s.date,
        title: `Study: ${s.topic}`,
        module: s.moduleCode,
        moduleCode: s.moduleCode,
        topic: s.topic,
        type: 'Study Session',
        color: moduleColors[s.moduleCode] || '#666',
        allDay: true,
        source: 'study'
      });
    }
  });

  localStorage.setItem('events', JSON.stringify(events));
}
function autoGenerateTodosFromStudySessions() {
  const sessions = JSON.parse(localStorage.getItem('studySessions') || '[]');
  let todos = JSON.parse(localStorage.getItem(TODO_KEY) || '[]');
  const today = todayISO();

  sessions
    .filter(s => s.date === today)
    .forEach(s => {
      const text = `Study ${s.moduleCode}: ${s.topic} (${s.assessment})`;

      const exists = todos.some(t => t.text === text && t.dateAdded === today);
      if (!exists) {
        todos.push({
          text,
          done: false,
          dateAdded: today,
          auto: true
        });
      }
    });

  localStorage.setItem(TODO_KEY, JSON.stringify(todos));
}
function autoGenerateTodosFromDueDates() {
  const assessments = JSON.parse(localStorage.getItem('assessments') || '[]');
  const today = getTodayISO();
  let todos = JSON.parse(localStorage.getItem(TODO_KEY) || '[]');

  assessments
    .filter(a => a.date === today)
    .forEach(a => {
      const text = `Submit ${a.moduleCode} ‚Äì ${a.type}`;

      const exists = todos.some(
        t => t.text === text && t.dateAdded === today
      );

      if (!exists) {
        todos.push({
          text,
          done: false,
          dateAdded: today,
          auto: true
        });
      }
    });

  localStorage.setItem(TODO_KEY, JSON.stringify(todos));
}

document.addEventListener('DOMContentLoaded', () => {
  renderWeeklyPlanner();
autoGenerateTodosFromDueDates();
  syncStudySessionsToCalendar();   // üìÖ planner ‚Üí calendar
  autoGenerateTodosFromStudySessions(); // üìù planner ‚Üí todos

  renderTodos();

  document.body.className = localStorage.getItem('theme') || 'theme-redblack';
  document.body.style.fontFamily = localStorage.getItem('font') || 'Arial';
});

</script>

</body>
</html>
